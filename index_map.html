<!DOCTYPE html>
<html>
<head>
    <title>Google Maps Parking Tests</title>
    <style type="text/css">

      html, body
      {
        height: 100%;
        margin: 0;
      }

      #map
      {
        height: 100%;
        width: 100%;
      }

    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    <script src="http://js.arcgis.com/3.13/"></script>
    <script type="text/javascript">

    function getJsonp(response) {
      console.log(response);
    }

    require(["esri/geometry/webMercatorUtils", "esri/SpatialReference", "esri/geometry/Point", "esri/geometry/Circle"], function(WebMercatorUtils, SpatialReference, Point, Circle) {

      // Gets the user's position
      function getUserPosition(success) {

        navigator.geolocation.getCurrentPosition(

          // Success
          function(position) {
            success(position.coords.latitude, position.coords.longitude);
          },

          // Error
          function(err) {

            // Use the default coordinates of Moz
            initMap(47.6061287, -122.335073);

          }

        );

      }

      // Initializes the map, centering on the specified latitude and longitude
      function initMap(latitude, longitude) {

        var mapOptions =
        {
          zoom: 20,
          center: new google.maps.LatLng(latitude, longitude),
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };

        var map = new google.maps.Map(document.getElementById('map'),
        mapOptions);

        google.maps.event.addListener(map, "click", function(event)
        {
          // Get the latitude and longitude selected by the user
          var lat = event.latLng.lat();
          var lon = event.latLng.lng();

          // Retrieve the X and Y coordinates
          var coords = convertCoordinates(lat, lon);

          // Get the bounding box
          var bound = getBoundingBox(coords.x, coords.y);

          // Construct the request URL
          var url = getParkingUrl(
            bound.xmin, bound.ymin, bound.xmax, bound.ymax, 'getJsonp');

          var script = document.createElement('script');
          script.src = url;

          document.getElementsByTagName('head')[0].appendChild(script);
        });

      }

      // Generates a URL that can be used to request parking category data
      function getParkingUrl(xmin, ymin, xmax, ymax, callback) {

        var baseUrl = "//gisrevprxy.seattle.gov/ArcGIS/rest/services/SDOT_EXT/sdot_parking/MapServer/7/query?";

        var params = 'f=json'
          + '&returnGeometry=true'
          + '&spatialRel=esriSpatialRelIntersects'
          + '&maxAllowableOffset=19'
          + '&geometry=' + encodeURIComponent('{'
              + '"xmin":' + xmin + ','
              + '"ymin":' + ymin + ','
              + '"xmax":' + xmax + ','
              + '"ymax":' + ymax + ','
              + '"spatialReference":{"wkid":102100,"latestWkid":3857}}')
          + '&geometryType=esriGeometryEnvelope'
          + '&inSR=102100'
          + '&outFields=OBJECTID,PARKING_CATEGORY'
          + '&outSR=102100'
          + '&callback=' + callback;

          return baseUrl + params;

      }

      // Returns a bounding box based on the specified X, Y coordinate
      function getBoundingBox(x, y) {

        var spatialReference = new SpatialReference();
        spatialReference.wkid = "102100";

        var point = new Point();
        point.spatialReference = spatialReference;
        point.x = x;
        point.y = y;

        var circle = new Circle({
          center: point,
          geodesic: true,
          radius: 50,
          radiusUnit: "esriFeet"
        });

        var bound = circle.getExtent();

        return {
          xmin: bound.xmin,
          xmax: bound.xmax,
          ymin: bound.ymin,
          ymax: bound.ymax
        };
      }

      // Converts latitude and longitude to X and Y coordinates
      function convertCoordinates(lat, lon) {

        var result = WebMercatorUtils.lngLatToXY(lon, lat);

        return {
          x: result[0],
          y: result[1]
        };

      }

      //console.log(convertCoordinates(47.606585, -122.336439));
      //console.log(getBoundingBox(-13618430.094942143, 6041652.3842038615));

      // -122.336439,
      // -13618430.094942143, 6041652.3842038615

      getUserPosition(initMap);

    });

    </script>
</body>
</html>

<!--
var watchID = geo.watchPosition(

// Position was successfully retrieved
function(position) {

onSuccess && onSuccess({
'latitude': position.coords.latitude,
'longitude': position.coords.latitude,
'accuracy': position.coords.accuracy
});

},

function(err) {
if (typeof onError == 'function')
onError(err);
},

// Options
{
enableHighAccuracy: highAccuracy,
maximumAge: timeout,
timeout: geoTimeout
}
);

return watchID;
}

this.clearWatch = function(watchID)
{
var geo = this.getApi();

if(geo !== null)
geo.clearWatch(watchID);
}
-->
